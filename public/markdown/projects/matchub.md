## 概要

**Matchub** は、日本拳法の大会運営を現代化・効率化するために開発された、**オフラインファースト・リアルタイム大会運営プラットフォーム**です。
高度な**得点板機能**だけでなく、**選手管理**や**対戦組み合わせ作成**といった大会運営の中核機能までをデジタル化。 Web技術（Next.js）とデスクトップ技術（Electron）を融合させ、**「ネットがない体育館でも動く」「ネットがあれば端末間でリアルタイムに同期できる」** ハイブリッドな運用環境を提供します。

---

## 開発背景

日本拳法の大会運営における「紙ベースの煩雑さ」「既存得点板の使いにくさ」という課題からスタートしました。
当初は単なるWeb得点板でしたが、現場の **「ネット環境が不安定な体育館で止まっては困る」** という切実な声に応えるため、アーキテクチャを根本から見直し、**完全オフライン動作** と **クラウド同期** を両立するシステムへと進化しました。

---

## 主な機能

### 1. 🛡️ オフラインファースト・アーキテクチャ
*   **ネット接続不要**: アプリケーションはローカルデータベース (**IndexedDB / Dexie.js**) で動作するため、インターネットが切断されても試合進行・データ保存が止まることはありません。
*   **自動同期**: ネット接続が復帰すると、バックグラウンドで自動的にクラウド (**Firebase**) とデータを同期します。データのコンフリクトを避けるため、オフライン中に変更した情報は手動で送信します。

### 2. 📺 リアルタイム・モニタースコアボード
*   **デュアルディスプレイ対応**: PCに接続された外部モニターやプロジェクターに、観客用のスコアボードを表示します。
*   **遅延ゼロ**: **Presentation API** を使用してブラウザから直接セカンドスクリーンを制御するため、ネットワーク遅延が一切ありません。
*   **フォールバック**: Presentation API非対応環境では、**Broadcast Channel API** を用いて別タブ表示モードに自動で切り替わります。

### 3. ⚡ インスタントモード
*   **登録不要**: アカウント登録や複雑な大会設定なしで、アプリを開いて選手名を入力するだけですぐにスコアリングを開始できます。

### 4. 📝 統合大会管理
*   **選手登録**: 参加者データの一元管理。
*   **トーナメント管理**: 勝ち上がり表の作成と進行管理（※開発中）。
*   **複数大会対応**: 新人戦・本戦など、複数の大会を並行して管理可能。

### 5. 💻 クロスプラットフォーム
*   **Web版**: インストール不要でブラウザから利用可能。
*   **デスクトップ版 (Electron)**: 専用アプリとしてインストールし、より安定したネイティブ体験を提供（完全なオフライン動作など）。

---

## 技術スタック

モダンなWeb技術をベースに、堅牢性とパフォーマンスを重視した選定を行っています。

### フロントエンド / アプリケーション
*   **Framework**: [Next.js 16 (App Router)](https://nextjs.org/) - 最新のReactサーバーコンポーネントアーキテクチャを採用。
*   **UI Library**: [React 19](https://react.dev/)
*   **Styling**: [Tailwind CSS](https://tailwindcss.com/) - メンテナンス性とデザインの統一性を確保。
*   **Desktop Wrapper**: [Electron](https://www.electronjs.org/) - Webアプリをネイティブデスクトップアプリとしてパッケージング。

### 状態管理・データ連携
*   **Local DB**: [Dexie.js](https://dexie.org/) (IndexedDB wrapper) - 高速なローカルデータ永続化。
*   **Server State**: [TanStack Query v5](https://tanstack.com/query/latest) - 非同期データの取得・キャッシュ・同期管理。
*   **Client State**: [Zustand](https://github.com/pmndrs/zustand) - 試合中のタイマーやスコアなど、高頻度で更新されるUI状態の管理。

### バックエンド / インフラ
*   **Cloud DB**: [Firebase Firestore](https://firebase.google.com/) - リアルタイムクラウドデータベース。
*   **Auth**: Firebase Authentication - 堅牢な認証システム。
*   **Serverless**: Firebase Cloud Functions - サーバーサイドロジック（データ整合性チェック、admin権限が必要な処理など）。
*   **Hosting**: Vercel (Web版)

---

## 技術的なこだわりと工夫

本プロジェクトでは、単なる機能実装だけでなく、実際の運用現場での「使いやすさ」と「継続的な開発」を支えるための技術的工夫を凝らしています。

### 1. オフライン動作を実現するID管理への転換
開発当初はオンライン前提で設計しており、通信量を削減して高速化するために、選手名などを正規化せず直接カラムに保存するアプローチを取っていました（マスターデータ変更時に関連箇所も更新する運用）。
しかし、「完全オフライン」への仕様変更に伴い、データ構造を刷新。**全データをローカルDBに一括取得・同期するアーキテクチャ**（Dexie.js + TanStack Query）へと移行し、リレーショナルなID管理による正規化されたデータ構造を採用しました。これにより、オフライン下でもデータの整合性を保ちながらスムーズな操作が可能になりました。

### 2. オペレーター体験 (UX) を重視したモニター操作画面
試合の進行を止めることなく、瞬時に戦況をスコアボードへ反映させるため、管理画面のUXには徹底的にこだわりました。
*   **高視認性UI**: パッと見て現在の状態がわかる情報の優先順位付け。
*   **キーボード操作**: マウスを使わず、キーボードショートカットだけで得点操作やタイマー制御が完結するように実装。物理的な操作スピードを向上させました。

### 3. デプロイの自動化とCI/CDパイプライン
継続的な改善をサポートするため、リリースフローを自動化しました。
*   **App Store Connect API連携**: GitHub Actionsと連携し、macOSアプリケーションのコード署名プロセスを自動化しました。
*   **Electronアプリの自動配信**: `main` ブランチへのマージ時、**PRタイトル（major/minor/指定なし）を解析してバージョンを自動採番**。ビルドから GitHub Releases へのインストーラー配置までを全自動化し、手動リリースの手間と人的ミスを排除しました。

### 4. ハイブリッド・シンク (Hybrid Sync)
Local-Firstなデータフローにより、**「スタンドアロンアプリの快適さ」** と **「クラウドアプリの利便性」** を両立しています。
1.  **Write Local**: 操作は即座にローカルDBに書き込み、UIをブロックしません。
2.  **Sync Background**: 通信回復時にバックグラウンドでクラウドと同期します。ただし、データ競合を防ぐため、**オフライン作業中に発生した変更箇所については、自動同期されず手動で送信**する安全設計としています。

---

## 開発で直面した技術的課題

### 1. ドメイン知識の不足と要件定義の重要性 (DDDの教訓)
当初の要件定義では、日本拳法の複雑なルールや運用フローへの理解が不足しており、開発途中で手戻りが発生しました。
*   **個人戦 vs 団体戦**: 個人戦想定で設計していたが、実際には団体戦がメインだった。
*   **勝敗ロジック**: 「一本先取」だけでなく、「不戦敗」「反則負」など例外的な勝ち負けが存在した。
*   **オフライン要件**: 選手登録後の運用はネット環境がない場所が大半だった。

これらは、事前にドメイン（日本拳法）のルールを深く理解し、運用フローを定義していれば防げた課題でした。**「作る前に業務を知る」** ことの重要性を痛感しました。

### 2. クロスプラットフォーム開発の落とし穴 (Windows vs Mac)
開発はMacを使用していましたが、実際の運営PCはWindowsが多く、**フォントレンダリングの違いによるレイアウト崩れ**が発生しました。
Windows開発機が手元になかったため、Mac上の仮想環境ツール (**UTM**) でWindows環境を構築し、Macで立ち上げた開発サーバーにwindows仮想環境からアクセスして表示確認を行うことで、OS間の差異に対応しました。

### 3. HMR (Hot Module Replacement) が効かない謎のバグ
開発中、コードを変更しても `npm run dev` (localhost:3000) に全く変更が反映されなくなる事象に遭遇しました。
ログが出ないためコードの問題を疑いましたが、静的なヘッダー文字すら変わらないことから、環境起因と判断。PWAのキャッシュクリア等を試しても解決せず、最終的に **「ゾンビプロセス化した別の開発サーバーがポート3000を占有していた」** ことが判明しました。
VS CodeとAIエディタを同時に起動していたことで意図せず複数のプロセスが立ち上がっていたことが原因でした。プロセスを全キルして再起動することで解決しました。

---

## 実際に使われた時の様子

{{matchubUsecase1|medium|試合に溶け込む得点板ディスプレイ}}
{{matchubUsecase2|medium|操作しているスタッフ}}

---

## 今後の展望

### 1. リアルタイム・トーナメント情報のWeb公開
現状、会場内の観客は「今どのチームが勝ち上がっているか」を知る手段が限られています。
Web上でリアルタイムに更新されるトーナメント表を表示する機能を開発し、**会場内にQRコードを掲示することで、観客が手元のスマホから戦況を確認できる** 仕組みを作りたいと考えています。

### 2. 大会ルールのカスタマイズ性向上
様々な地域のローカルルールや、大会ごとの特殊な規定に対応できるよう、大会設定画面のパラメーターを充実させ、柔軟な運用を可能にします。

### 3. スーパーユーザー管理画面とマルチテナント化
現在は1団体での利用ですが、既に他団体からの利用希望があります。
システム全体を管理する **スーパーユーザー権限** や、組織ごとの権限管理を強化し、本格的な **SaaS型マルチテナント運用** に向けた認証基盤と管理UIを整備していきます。